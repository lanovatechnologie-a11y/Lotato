<!DOCTYPE html>
<html lang="fr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Nova Lotto - Centre de Contrôle</title>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <!-- Inclure Firebase -->
    <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-firestore-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-auth-compat.js"></script>
    <style>
        :root {
            --primary-color: #2c3e50;
            --secondary-color: #3498db;
            --accent-color: #e74c3c;
            --success-color: #27ae60;
            --warning-color: #f39c12;
            --light-color: #ecf0f1;
            --dark-color: #2c3e50;
        }
        
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
        }
        
        body {
            background-color: #f5f7fa;
            color: var(--dark-color);
            line-height: 1.6;
        }
        
        .container {
            max-width: 1200px;
            margin: 0 auto;
            padding: 20px;
        }
        
        header {
            background: linear-gradient(135deg, var(--primary-color), #1a2530);
            color: white;
            padding: 20px;
            text-align: center;
            border-radius: 12px;
            margin-bottom: 20px;
            box-shadow: 0 4px 6px rgba(0, 0, 0, 0.1);
        }
        
        .header-content {
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 15px;
        }
        
        .logo {
            font-size: 2.5rem;
            color: var(--warning-color);
        }
        
        .header-text h1 {
            font-size: 2rem;
            margin-bottom: 5px;
        }
        
        .header-text p {
            font-size: 1rem;
            opacity: 0.9;
        }
        
        .dashboard {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 20px;
            margin-bottom: 20px;
        }
        
        .card {
            background-color: white;
            border-radius: 12px;
            box-shadow: 0 4px 6px rgba(0, 0, 0, 0.1);
            padding: 20px;
        }
        
        .card-header {
            display: flex;
            align-items: center;
            margin-bottom: 15px;
            padding-bottom: 10px;
            border-bottom: 1px solid var(--light-color);
        }
        
        .card-header i {
            margin-right: 10px;
            color: var(--secondary-color);
            font-size: 1.5rem;
        }
        
        .card-header h2 {
            font-size: 1.5rem;
            color: var(--primary-color);
        }
        
        .stats-grid {
            display: grid;
            grid-template-columns: repeat(3, 1fr);
            gap: 15px;
        }
        
        .stat-card {
            background-color: var(--light-color);
            padding: 15px;
            border-radius: 8px;
            text-align: center;
        }
        
        .stat-value {
            font-size: 1.8rem;
            font-weight: bold;
            color: var(--primary-color);
        }
        
        .stat-label {
            font-size: 0.9rem;
            color: #7f8c8d;
        }
        
        .terminals-list {
            max-height: 400px;
            overflow-y: auto;
        }
        
        .terminal-item {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 15px;
            border-bottom: 1px solid var(--light-color);
        }
        
        .terminal-item:last-child {
            border-bottom: none;
        }
        
        .terminal-info {
            flex: 2;
        }
        
        .terminal-name {
            font-weight: bold;
            margin-bottom: 5px;
        }
        
        .terminal-id {
            font-size: 0.9rem;
            color: #7f8c8d;
        }
        
        .terminal-status {
            flex: 1;
            text-align: center;
        }
        
        .status-connected {
            color: var(--success-color);
            font-weight: bold;
        }
        
        .status-disconnected {
            color: var(--accent-color);
            font-weight: bold;
        }
        
        .terminal-actions {
            flex: 1;
            display: flex;
            gap: 10px;
            justify-content: flex-end;
        }
        
        .btn {
            padding: 8px 15px;
            border: none;
            border-radius: 6px;
            font-size: 0.9rem;
            cursor: pointer;
            transition: background-color 0.3s;
        }
        
        .btn-primary {
            background-color: var(--secondary-color);
            color: white;
        }
        
        .btn-primary:hover {
            background-color: #2980b9;
        }
        
        .btn-danger {
            background-color: var(--accent-color);
            color: white;
        }
        
        .btn-danger:hover {
            background-color: #c0392b;
        }
        
        .btn-warning {
            background-color: var(--warning-color);
            color: white;
        }
        
        .btn-warning:hover {
            background-color: #e67e22;
        }
        
        .btn-success {
            background-color: var(--success-color);
            color: white;
        }
        
        .btn-success:hover {
            background-color: #219955;
        }
        
        .games-control {
            margin-top: 20px;
        }
        
        .games-grid {
            display: grid;
            grid-template-columns: repeat(3, 1fr);
            gap: 15px;
        }
        
        .game-item {
            background-color: var(--light-color);
            padding: 15px;
            border-radius: 8px;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }
        
        .game-name {
            font-weight: bold;
        }
        
        .toggle-switch {
            position: relative;
            display: inline-block;
            width: 50px;
            height: 24px;
        }
        
        .toggle-switch input {
            opacity: 0;
            width: 0;
            height: 0;
        }
        
        .slider {
            position: absolute;
            cursor: pointer;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background-color: #ccc;
            transition: .4s;
            border-radius: 24px;
        }
        
        .slider:before {
            position: absolute;
            content: "";
            height: 16px;
            width: 16px;
            left: 4px;
            bottom: 4px;
            background-color: white;
            transition: .4s;
            border-radius: 50%;
        }
        
        input:checked + .slider {
            background-color: var(--success-color);
        }
        
        input:checked + .slider:before {
            transform: translateX(26px);
        }
        
        .form-group {
            margin-bottom: 15px;
        }
        
        label {
            display: block;
            margin-bottom: 5px;
            font-weight: 600;
        }
        
        input, select, textarea {
            width: 100%;
            padding: 12px;
            border: 1px solid #ddd;
            border-radius: 8px;
            font-size: 1rem;
        }
        
        .form-actions {
            display: flex;
            gap: 10px;
            margin-top: 20px;
        }
        
        .winners-section {
            margin-top: 20px;
        }
        
        .winners-list {
            max-height: 300px;
            overflow-y: auto;
        }
        
        .winner-item {
            display: flex;
            justify-content: space-between;
            padding: 12px 0;
            border-bottom: 1px solid var(--light-color);
        }
        
        .winner-item:last-child {
            border-bottom: none;
        }
        
        .winner-details {
            flex: 2;
        }
        
        .winner-amount {
            flex: 1;
            text-align: right;
            font-weight: bold;
            color: var(--success-color);
        }
        
        .modal {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background-color: rgba(0, 0, 0, 0.5);
            z-index: 1000;
            align-items: center;
            justify-content: center;
        }
        
        .modal-content {
            background-color: white;
            border-radius: 12px;
            padding: 30px;
            width: 500px;
            max-width: 90%;
            box-shadow: 0 4px 20px rgba(0, 0, 0, 0.2);
        }
        
        .modal-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 20px;
            padding-bottom: 15px;
            border-bottom: 1px solid var(--light-color);
        }
        
        .modal-title {
            font-size: 1.5rem;
            color: var(--primary-color);
        }
        
        .close-modal {
            background: none;
            border: none;
            font-size: 1.5rem;
            cursor: pointer;
            color: var(--accent-color);
        }
        
        .terminal-selector {
            display: grid;
            grid-template-columns: repeat(2, 1fr);
            gap: 10px;
            margin-bottom: 20px;
        }
        
        .terminal-option {
            background-color: var(--light-color);
            padding: 15px;
            border-radius: 8px;
            text-align: center;
            cursor: pointer;
            transition: background-color 0.3s;
        }
        
        .terminal-option:hover {
            background-color: #dde4e6;
        }
        
        .terminal-option.selected {
            background-color: var(--secondary-color);
            color: white;
        }
        
        .tab-container {
            margin-top: 20px;
        }
        
        .tabs {
            display: flex;
            border-bottom: 1px solid var(--light-color);
            margin-bottom: 20px;
        }
        
        .tab {
            padding: 10px 20px;
            cursor: pointer;
            border-bottom: 3px solid transparent;
        }
        
        .tab.active {
            border-bottom: 3px solid var(--secondary-color);
            color: var(--secondary-color);
            font-weight: bold;
        }
        
        .tab-content {
            display: none;
        }
        
        .tab-content.active {
            display: block;
        }
        
        .logs-container {
            max-height: 400px;
            overflow-y: auto;
            background-color: #2c3e50;
            color: white;
            padding: 15px;
            border-radius: 8px;
            font-family: monospace;
            font-size: 0.9rem;
        }
        
        .log-entry {
            margin-bottom: 5px;
            padding-bottom: 5px;
            border-bottom: 1px solid #34495e;
        }
        
        .log-time {
            color: #7f8c8d;
        }
        
        .log-info {
            color: var(--secondary-color);
        }
        
        .log-warning {
            color: var(--warning-color);
        }
        
        .log-error {
            color: var(--accent-color);
        }
        
        .log-success {
            color: var(--success-color);
        }
        
        /* Nouveaux styles pour les codes d'accès */
        .codes-section {
            margin-top: 20px;
        }
        
        .codes-list {
            max-height: 300px;
            overflow-y: auto;
        }
        
        .code-item {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 12px;
            border-bottom: 1px solid var(--light-color);
            background-color: #f9f9f9;
            border-radius: 6px;
            margin-bottom: 8px;
        }
        
        .code-details {
            flex: 2;
        }
        
        .code-value {
            font-family: monospace;
            font-weight: bold;
            font-size: 1.1rem;
            color: var(--primary-color);
        }
        
        .code-type {
            font-size: 0.8rem;
            color: #7f8c8d;
            margin-top: 4px;
        }
        
        .code-status {
            flex: 1;
            text-align: center;
        }
        
        .status-active {
            color: var(--success-color);
            font-weight: bold;
        }
        
        .status-inactive {
            color: var(--accent-color);
            font-weight: bold;
        }
        
        .code-actions {
            flex: 1;
            display: flex;
            gap: 5px;
            justify-content: flex-end;
        }
        
        /* Login screen */
        .login-screen {
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: linear-gradient(135deg, var(--primary-color), #1a2530);
            display: flex;
            flex-direction: column;
            justify-content: center;
            align-items: center;
            z-index: 2000;
            padding: 20px;
        }
        
        .login-container {
            background-color: white;
            border-radius: 12px;
            padding: 30px;
            box-shadow: 0 10px 25px rgba(0, 0, 0, 0.2);
            width: 100%;
            max-width: 400px;
        }
        
        .login-logo {
            text-align: center;
            margin-bottom: 20px;
        }
        
        .login-logo .logo {
            font-size: 3rem;
            color: var(--warning-color);
        }
        
        .login-title {
            text-align: center;
            margin-bottom: 20px;
            color: var(--primary-color);
        }
        
        .login-error {
            background-color: #f8d7da;
            color: #721c24;
            padding: 10px;
            border-radius: 6px;
            margin-bottom: 15px;
            text-align: center;
            display: none;
        }
        
        /* Firestore data */
        .data-section {
            margin-top: 20px;
        }
        
        .data-list {
            max-height: 400px;
            overflow-y: auto;
        }
        
        .data-item {
            background-color: #f9f9f9;
            padding: 15px;
            border-radius: 8px;
            margin-bottom: 10px;
            border-left: 4px solid var(--secondary-color);
        }
        
        .data-header {
            display: flex;
            justify-content: space-between;
            margin-bottom: 10px;
            padding-bottom: 5px;
            border-bottom: 1px solid #eee;
        }
        
        .data-terminal {
            font-weight: bold;
            color: var(--primary-color);
        }
        
        .data-date {
            color: #7f8c8d;
            font-size: 0.9rem;
        }
        
        .data-content {
            font-size: 0.9rem;
        }
        
        .data-total {
            font-weight: bold;
            color: var(--success-color);
            margin-top: 5px;
        }
    </style>
</head>
<body>
    <!-- Écran de connexion -->
    <div class="login-screen" id="login-screen">
        <div class="login-container">
            <div class="login-logo">
                <div class="logo">
                    <i class="fas fa-server"></i>
                </div>
            </div>
            <h2 class="login-title">Nova Lotto - Contrôle</h2>
            <div class="login-error" id="login-error">
                Code d'accès incorrect ou centre de contrôle déjà ouvert sur un autre ordinateur.
            </div>
            <div class="form-group">
                <label for="admin-code">Code Administrateur</label>
                <input type="password" id="admin-code" placeholder="Entrez le code d'accès">
            </div>
            <button class="btn btn-primary" style="width: 100%; padding: 12px;" id="login-btn">
                <i class="fas fa-sign-in-alt"></i> Se Connecter
            </button>
        </div>
    </div>
    
    <div class="container" id="main-container" style="display: none;">
        <header>
            <div class="header-content">
                <div class="logo">
                    <i class="fas fa-server"></i>
                </div>
                <div class="header-text">
                    <h1>Nova Lotto - Centre de Contrôle</h1>
                    <p>Gestion centralisée des terminaux de jeu</p>
                </div>
                <div style="margin-left: auto;">
                    <button class="btn btn-danger" id="logout-btn">
                        <i class="fas fa-sign-out-alt"></i> Déconnexion
                    </button>
                </div>
            </div>
        </header>
        
        <div class="dashboard">
            <div class="card">
                <div class="card-header">
                    <i class="fas fa-chart-bar"></i>
                    <h2>Aperçu du Système</h2>
                </div>
                <div class="stats-grid">
                    <div class="stat-card">
                        <div class="stat-value" id="total-terminals">0</div>
                        <div class="stat-label">Terminaux</div>
                    </div>
                    <div class="stat-card">
                        <div class="stat-value" id="active-terminals">0</div>
                        <div class="stat-label">Actifs</div>
                    </div>
                    <div class="stat-card">
                        <div class="stat-value" id="total-sales">0</div>
                        <div class="stat-label">Ventes (G)</div>
                    </div>
                </div>
            </div>
            
            <div class="card">
                <div class="card-header">
                    <i class="fas fa-cog"></i>
                    <h2>Actions Rapides</h2>
                </div>
                <div class="form-actions">
                    <button class="btn btn-primary" id="refresh-data">
                        <i class="fas fa-sync-alt"></i> Actualiser
                    </button>
                    <button class="btn btn-warning" id="send-winners">
                        <i class="fas fa-trophy"></i> Envoyer Gagnants
                    </button>
                    <button class="btn btn-danger" id="shutdown-all">
                        <i class="fas fa-power-off"></i> Fermer Tous
                    </button>
                </div>
            </div>
        </div>
        
        <div class="card">
            <div class="tab-container">
                <div class="tabs">
                    <div class="tab active" data-tab="terminals">Terminaux</div>
                    <div class="tab" data-tab="tickets">Tickets Reçus</div>
                    <div class="tab" data-tab="codes">Codes d'Accès</div>
                    <div class="tab" data-tab="games">Jeux</div>
                    <div class="tab" data-tab="winners">Gagnants</div>
                    <div class="tab" data-tab="logs">Journaux</div>
                    <div class="tab" data-tab="settings">Paramètres</div>
                </div>
                
                <!-- Onglet Terminaux -->
                <div class="tab-content active" id="terminals-tab">
                    <div class="card-header">
                        <i class="fas fa-desktop"></i>
                        <h2>Terminaux Connectés</h2>
                    </div>
                    <div class="terminals-list" id="terminals-list">
                        <!-- Les terminaux seront chargés dynamiquement -->
                    </div>
                </div>
                
                <!-- Onglet Tickets Reçus -->
                <div class="tab-content" id="tickets-tab">
                    <div class="card-header">
                        <i class="fas fa-ticket-alt"></i>
                        <h2>Tickets Reçus des Terminaux</h2>
                    </div>
                    <div class="data-section">
                        <div class="form-group">
                            <div class="form-actions">
                                <button class="btn btn-primary" id="sync-tickets">
                                    <i class="fas fa-sync-alt"></i> Synchroniser Tickets
                                </button>
                                <button class="btn btn-danger" id="clear-tickets">
                                    <i class="fas fa-trash"></i> Effacer Anciens
                                </button>
                            </div>
                        </div>
                        <div class="data-list" id="tickets-list">
                            <!-- Les tickets seront chargés dynamiquement -->
                        </div>
                    </div>
                </div>
                
                <!-- Onglet Codes d'Accès -->
                <div class="tab-content" id="codes-tab">
                    <div class="card-header">
                        <i class="fas fa-key"></i>
                        <h2>Gestion des Codes d'Accès</h2>
                    </div>
                    <div class="codes-section">
                        <div class="form-group">
                            <label for="generate-count">Générer Nouveaux Codes</label>
                            <div style="display: flex; gap: 10px;">
                                <input type="number" id="generate-count" placeholder="Nombre" min="1" max="100" value="10" style="flex: 1;">
                                <select id="code-type" style="flex: 1;">
                                    <option value="agent">Agent (Terminal)</option>
                                    <option value="admin">Administrateur (Contrôle)</option>
                                </select>
                                <button class="btn btn-success" id="generate-codes">
                                    <i class="fas fa-plus"></i> Générer
                                </button>
                            </div>
                            <small>Les codes agents sont pour les terminaux (bòlèt ok5), les codes admin pour le centre de contrôle</small>
                        </div>
                        
                        <div class="form-group">
                            <label>Rechercher un Code</label>
                            <div style="display: flex; gap: 10px;">
                                <input type="text" id="search-code" placeholder="Code ou terminal..." style="flex: 3;">
                                <button class="btn btn-primary" id="search-btn">
                                    <i class="fas fa-search"></i> Rechercher
                                </button>
                            </div>
                        </div>
                        
                        <div class="codes-list" id="codes-list">
                            <!-- Les codes seront chargés dynamiquement -->
                        </div>
                    </div>
                </div>
                
                <!-- Onglet Jeux -->
                <div class="tab-content" id="games-tab">
                    <div class="card-header">
                        <i class="fas fa-gamepad"></i>
                        <h2>Contrôle des Jeux</h2>
                    </div>
                    <div class="games-control">
                        <div class="games-grid" id="games-grid">
                            <!-- Les jeux seront chargés dynamiquement -->
                        </div>
                        
                        <div class="form-actions">
                            <button class="btn btn-primary" id="apply-games">
                                <i class="fas fa-check"></i> Appliquer aux Terminaux
                            </button>
                            <button class="btn btn-warning" id="select-terminals">
                                <i class="fas fa-laptop"></i> Sélectionner Terminaux
                            </button>
                        </div>
                    </div>
                </div>
                
                <!-- Onglet Gagnants -->
                <div class="tab-content" id="winners-tab">
                    <div class="card-header">
                        <i class="fas fa-trophy"></i>
                        <h2>Gagnants du Jour</h2>
                    </div>
                    <div class="winners-section">
                        <div class="form-group">
                            <label for="draw-select">Sélectionner le Tirage</label>
                            <select id="draw-select">
                                <option value="miami-morning">Miami (Matin)</option>
                                <option value="miami-evening">Miami (Soir)</option>
                                <option value="georgia-morning">Georgia (Matin)</option>
                                <option value="georgia-evening">Georgia (Soir)</option>
                                <option value="newyork-morning">New York (Matin)</option>
                                <option value="newyork-evening">New York (Soir)</option>
                                <option value="texas-morning">Texas (Matin)</option>
                                <option value="texas-evening">Texas (Soir)</option>
                            </select>
                        </div>
                        
                        <div class="form-group">
                            <label for="winner-numbers">Numéros Gagnants</label>
                            <input type="text" id="winner-numbers" placeholder="Ex: 451, 327, 892">
                        </div>
                        
                        <div class="form-actions">
                            <button class="btn btn-success" id="add-winners">
                                <i class="fas fa-plus"></i> Ajouter Gagnants
                            </button>
                            <button class="btn btn-primary" id="publish-winners">
                                <i class="fas fa-broadcast-tower"></i> Publier aux Terminaux
                            </button>
                        </div>
                        
                        <div class="winners-list" id="winners-list">
                            <!-- Les gagnants seront chargés dynamiquement -->
                        </div>
                    </div>
                </div>
                
                <!-- Onglet Journaux -->
                <div class="tab-content" id="logs-tab">
                    <div class="card-header">
                        <i class="fas fa-clipboard-list"></i>
                        <h2>Journaux Système</h2>
                    </div>
                    <div class="logs-container" id="logs-container">
                        <!-- Les journaux seront chargés dynamiquement -->
                    </div>
                </div>
                
                <!-- Onglet Paramètres -->
                <div class="tab-content" id="settings-tab">
                    <div class="card-header">
                        <i class="fas fa-sliders-h"></i>
                        <h2>Paramètres du Système</h2>
                    </div>
                    <div class="form-group">
                        <label for="firebase-config">Configuration Firebase</label>
                        <textarea id="firebase-config" rows="6" placeholder='{
  apiKey: "AIzaSyCZrBwRmlLq-UyWYh8vuPv9G6kmKaKrlag",  // ✅ NOUVELLE CLÉ
  authDomain: "novatechnologie-5.firebaseapp.com",     // ✅ NOUVELLE
  projectId: "novatechnologie-5",                      // ✅ NOUVELLE
  storageBucket: "novatechnologie-5.firebasestorage.app", // ✅ NOUVELLE
  messagingSenderId: "515258648592",                   // ✅ NOUVELLE
  appId: "1:515258648592:web:9bab015cf5d65f98fba295"  // ✅ NOTE: appId DIFFÉRENTE!
};
}'></textarea>
                    </div>
                    
                    <div class="form-group">
                        <label for="server-port">Port du Serveur Local</label>
                        <input type="number" id="server-port" value="8080">
                    </div>
                    
                    <div class="form-group">
                        <label for="sync-interval">Intervalle de Synchronisation (minutes)</label>
                        <input type="number" id="sync-interval" value="5" min="1">
                    </div>
                    
                    <div class="form-group">
                        <label for="auto-shutdown">Heure d'Arrêt Automatique</label>
                        <input type="time" id="auto-shutdown" value="22:00">
                    </div>
                    
                    <div class="form-actions">
                        <button class="btn btn-primary" id="save-settings">
                            <i class="fas fa-save"></i> Sauvegarder Paramètres
                        </button>
                        <button class="btn btn-success" id="test-firebase">
                            <i class="fas fa-bolt"></i> Tester Firebase
                        </button>
                    </div>
                </div>
            </div>
        </div>
    </div>
    
    <!-- Modal pour sélectionner les terminaux -->
    <div class="modal" id="terminals-modal">
        <div class="modal-content">
            <div class="modal-header">
                <h3 class="modal-title">Sélectionner les Terminaux</h3>
                <button class="close-modal">&times;</button>
            </div>
            <div class="terminal-selector" id="terminal-selector">
                <!-- Les options de terminal seront chargées dynamiquement -->
            </div>
            <div class="form-actions">
                <button class="btn btn-primary" id="select-all">Tout Sélectionner</button>
                <button class="btn btn-secondary" id="deselect-all">Tout Désélectionner</button>
                <button class="btn btn-success" id="confirm-selection">Confirmer</button>
            </div>
        </div>
    </div>

    <script>
        // Configuration Firebase
        let firebaseConfig = {
  apiKey: "AIzaSyCZrBwRmlLq-UyWYh8vuPv9G6kmKaKrlag",
  authDomain: "novatechnologie-5.firebaseapp.com",
  projectId: "novatechnologie-5",
  storageBucket: "novatechnologie-5.firebasestorage.app",
  messagingSenderId: "515258648592",
  appId: "1:515258648592:web:33f0420811f7fe01fba295"
};
        // Initialiser Firebase
        let firebaseApp;
        let db;
        let auth;
        
        // Données de l'application
        let terminals = [];
        let selectedTerminals = [];
        let games = [];
        let winners = [];
        let systemLogs = [];
        let accessCodes = [];
        let receivedTickets = [];
        let serverSettings = {};
        let currentAdminCode = "";
        let isAuthenticated = false;
        
        // Codes admin par défaut (pour premier accès)
        const defaultAdminCodes = ["ADMIN123", "CONTROL456", "MASTER789"];
        
        // Initialisation
        document.addEventListener('DOMContentLoaded', function() {
            // Charger les paramètres
            loadSettings();
            
            // Initialiser Firebase
            initializeFirebase();
            
            // Ajouter les écouteurs d'événements
            setupEventListeners();
            
            // Vérifier la session existante
            checkExistingSession();
        });
        
        // Charger les paramètres
        function loadSettings() {
            const savedSettings = localStorage.getItem('novaLottoControlSettings');
            if (savedSettings) {
                serverSettings = JSON.parse(savedSettings);
                if (serverSettings.firebaseConfig) {
                    firebaseConfig = serverSettings.firebaseConfig;
                }
                document.getElementById('server-port').value = serverSettings.port || 8080;
                document.getElementById('sync-interval').value = serverSettings.syncInterval || 5;
                document.getElementById('auto-shutdown').value = serverSettings.autoShutdown || '22:00';
                if (serverSettings.firebaseConfig) {
                    document.getElementById('firebase-config').value = JSON.stringify(serverSettings.firebaseConfig, null, 2);
                }
            }
        }
        
        // Initialiser Firebase
        function initializeFirebase() {
            try {
                firebaseApp = firebase.initializeApp(firebaseConfig);
                db = firebase.firestore();
                auth = firebase.auth();
                
                // Mode démo si Firebase n'est pas configuré
                if (firebaseConfig.apiKey === "AIzaSyABC123DEF456ghi789jkl012mno345pqr") {
                    addLog("Mode démo activé - Configurez Firebase pour utiliser toutes les fonctionnalités", "warning");
                    return;
                }
                
                addLog("Firebase initialisé avec succès", "success");
                
                // Configurer les écouteurs en temps réel
                setupFirebaseListeners();
                
            } catch (error) {
                console.error("Erreur Firebase:", error);
                addLog("Erreur d'initialisation Firebase: " + error.message, "error");
            }
        }
        
        // Configurer les écouteurs Firebase
        function setupFirebaseListeners() {
            if (!db) return;
            
            // Écouter les terminaux
            db.collection("terminals").onSnapshot((snapshot) => {
                terminals = [];
                snapshot.forEach((doc) => {
                    terminals.push({
                        id: doc.id,
                        ...doc.data()
                    });
                });
                updateDashboard();
                updateTerminalsList();
                addLog(`${terminals.length} terminaux chargés`, "info");
            });
            
            // Écouter les tickets
            db.collection("tickets").orderBy("timestamp", "desc").limit(50)
                .onSnapshot((snapshot) => {
                    receivedTickets = [];
                    snapshot.forEach((doc) => {
                        receivedTickets.push({
                            id: doc.id,
                            ...doc.data()
                        });
                    });
                    updateTicketsList();
                });
            
            // Écouter les codes d'accès
            db.collection("access_codes").onSnapshot((snapshot) => {
                accessCodes = [];
                snapshot.forEach((doc) => {
                    accessCodes.push({
                        id: doc.id,
                        ...doc.data()
                    });
                });
                updateCodesList();
            });
            
            // Écouter les gagnants
            db.collection("winners").orderBy("date", "desc").onSnapshot((snapshot) => {
                winners = [];
                snapshot.forEach((doc) => {
                    winners.push({
                        id: doc.id,
                        ...doc.data()
                    });
                });
                updateWinnersList();
            });
        }
        
        // Vérifier la session existante
        function checkExistingSession() {
            const adminCode = localStorage.getItem('novaLottoAdminCode');
            const deviceId = localStorage.getItem('novaLottoControlDeviceId');
            
            if (adminCode && deviceId) {
                // Vérifier dans Firebase si le code est valide
                verifyAdminCode(adminCode, deviceId);
            }
        }
        
        // Configurer les écouteurs d'événements
        function setupEventListeners() {
            // Connexion
            document.getElementById('login-btn').addEventListener('click', login);
            document.getElementById('admin-code').addEventListener('keypress', function(e) {
                if (e.key === 'Enter') login();
            });
            
            // Déconnexion
            document.getElementById('logout-btn').addEventListener('click', logout);
            
            // Onglets
            document.querySelectorAll('.tab').forEach(tab => {
                tab.addEventListener('click', function() {
                    const tabId = this.getAttribute('data-tab');
                    switchTab(tabId);
                });
            });
            
            // Actions
            document.getElementById('refresh-data').addEventListener('click', refreshData);
            document.getElementById('send-winners').addEventListener('click', sendWinnersToTerminals);
            document.getElementById('shutdown-all').addEventListener('click', shutdownAllTerminals);
            document.getElementById('apply-games').addEventListener('click', applyGamesToTerminals);
            document.getElementById('select-terminals').addEventListener('click', showTerminalsModal);
            document.getElementById('add-winners').addEventListener('click', addWinners);
            document.getElementById('publish-winners').addEventListener('click', publishWinners);
            document.getElementById('save-settings').addEventListener('click', saveSettings);
            document.getElementById('test-firebase').addEventListener('click', testFirebase);
            
            // Tickets
            document.getElementById('sync-tickets').addEventListener('click', syncTickets);
            document.getElementById('clear-tickets').addEventListener('click', clearOldTickets);
            
            // Codes d'accès
            document.getElementById('generate-codes').addEventListener('click', generateAccessCodes);
            document.getElementById('search-btn').addEventListener('click', searchCodes);
            
            // Événements pour le modal
            document.querySelector('.close-modal').addEventListener('click', closeModal);
            document.getElementById('select-all').addEventListener('click', selectAllTerminals);
            document.getElementById('deselect-all').addEventListener('click', deselectAllTerminals);
            document.getElementById('confirm-selection').addEventListener('click', confirmTerminalSelection);
        }
        
        // Connexion
        async function login() {
            const adminCode = document.getElementById('admin-code').value.trim();
            
            if (!adminCode) {
                showLoginError("Veuillez entrer un code d'accès");
                return;
            }
            
            // Générer un ID d'appareil unique
            const deviceId = generateDeviceId();
            
            // Vérifier le code
            await verifyAdminCode(adminCode, deviceId);
        }
        
        // Vérifier le code admin
        async function verifyAdminCode(code, deviceId) {
            try {
                if (!db) {
                    // Mode démo - vérifier les codes par défaut
                    if (defaultAdminCodes.includes(code)) {
                        completeLogin(code, deviceId);
                        return;
                    }
                    showLoginError("Code admin incorrect");
                    return;
                }
                
                // Vérifier dans Firebase
                const codesRef = db.collection("access_codes");
                const query = codesRef.where("code", "==", code)
                                     .where("type", "==", "admin")
                                     .where("active", "==", true)
                                     .limit(1);
                
                const snapshot = await query.get();
                
                if (snapshot.empty) {
                    showLoginError("Code admin incorrect ou inactif");
                    return;
                }
                
                const codeDoc = snapshot.docs[0];
                const codeData = codeDoc.data();
                
                // Vérifier si le code est déjà utilisé sur un autre appareil
                if (codeData.deviceId && codeData.deviceId !== deviceId) {
                    showLoginError("Ce code est déjà utilisé sur un autre ordinateur");
                    return;
                }
                
                // Mettre à jour avec le nouvel appareil
                await codeDoc.ref.update({
                    deviceId: deviceId,
                    lastUsed: new Date().toISOString()
                });
                
                completeLogin(code, deviceId);
                
            } catch (error) {
                console.error("Erreur vérification code:", error);
                showLoginError("Erreur de connexion: " + error.message);
            }
        }
        
        // Compléter la connexion
        function completeLogin(adminCode, deviceId) {
            isAuthenticated = true;
            currentAdminCode = adminCode;
            
            // Sauvegarder la session
            localStorage.setItem('novaLottoAdminCode', adminCode);
            localStorage.setItem('novaLottoControlDeviceId', deviceId);
            
            // Afficher l'interface principale
            document.getElementById('login-screen').style.display = 'none';
            document.getElementById('main-container').style.display = 'block';
            
            // Charger les données
            loadData();
            
            addLog("Connexion réussie en tant qu'administrateur", "success");
        }
        
        // Déconnexion
        function logout() {
            if (!confirm("Êtes-vous sûr de vouloir vous déconnecter ?")) return;
            
            // Effacer la session locale
            localStorage.removeItem('novaLottoAdminCode');
            localStorage.removeItem('novaLottoControlDeviceId');
            
            // Réinitialiser Firebase
            if (auth) {
                auth.signOut();
            }
            
            // Revenir à l'écran de connexion
            document.getElementById('login-screen').style.display = 'flex';
            document.getElementById('main-container').style.display = 'none';
            document.getElementById('admin-code').value = '';
            document.getElementById('login-error').style.display = 'none';
            
            isAuthenticated = false;
            currentAdminCode = "";
            
            addLog("Déconnexion réussie", "info");
        }
        
        // Afficher l'erreur de connexion
        function showLoginError(message) {
            const errorElem = document.getElementById('login-error');
            errorElem.textContent = message;
            errorElem.style.display = 'block';
        }
        
        // Générer un ID d'appareil unique
        function generateDeviceId() {
            let deviceId = localStorage.getItem('novaLottoControlDeviceId');
            if (!deviceId) {
                deviceId = 'control_' + Date.now() + '_' + Math.random().toString(36).substr(2, 9);
            }
            return deviceId;
        }
        
        // Charger les données
        function loadData() {
            // Charger les jeux
            games = [
                { id: 'lotto3', name: 'LOTO 3', enabled: true },
                { id: 'grap', name: 'GRAP', enabled: true },
                { id: 'marriage', name: 'MARYAJ', enabled: true },
                { id: 'borlette', name: 'BORLETTE', enabled: true },
                { id: 'boulpe', name: 'BOUL PE', enabled: true },
                { id: 'lotto4', name: 'LOTO 4', enabled: false },
                { id: 'lotto5', name: 'LOTO 5', enabled: false }
            ];
            
            // Initialiser la sélection de terminaux
            selectedTerminals = terminals.map(t => t.id);
            
            // Mettre à jour l'interface
            updateDashboard();
            updateTerminalsList();
            updateGamesControl();
            updateWinnersList();
            updateLogs();
            updateCodesList();
            updateTicketsList();
            
            // Ajouter un log de démarrage
            addLog("Système de contrôle démarré avec succès", "success");
            
            // Si Firebase est configuré, charger les données réelles
            if (db) {
                addLog("Connexion à la base de données établie", "success");
            }
        }
        
        // Mettre à jour le tableau de bord
        function updateDashboard() {
            const totalTerminals = terminals.length;
            const activeTerminals = terminals.filter(t => t.status === 'connected').length;
            const totalSales = terminals.reduce((sum, t) => sum + (t.sales || 0), 0);
            
            document.getElementById('total-terminals').textContent = totalTerminals;
            document.getElementById('active-terminals').textContent = activeTerminals;
            document.getElementById('total-sales').textContent = totalSales.toLocaleString();
        }
        
        // Mettre à jour la liste des terminaux
        function updateTerminalsList() {
            const terminalsList = document.getElementById('terminals-list');
            terminalsList.innerHTML = '';
            
            if (terminals.length === 0) {
                terminalsList.innerHTML = '<p>Aucun terminal connecté pour le moment.</p>';
                return;
            }
            
            terminals.forEach(terminal => {
                const terminalItem = document.createElement('div');
                terminalItem.className = 'terminal-item';
                
                const statusClass = terminal.status === 'connected' ? 'status-connected' : 'status-disconnected';
                const statusText = terminal.status === 'connected' ? 'Connecté' : 'Déconnecté';
                const lastSeen = terminal.lastSeen ? new Date(terminal.lastSeen).toLocaleTimeString() : 'Jamais';
                const sales = terminal.sales || 0;
                
                terminalItem.innerHTML = `
                    <div class="terminal-info">
                        <div class="terminal-name">${terminal.name || terminal.id}</div>
                        <div class="terminal-id">${terminal.id} - Dernière activité: ${lastSeen}</div>
                        <div class="terminal-sales">Ventes: ${sales} G</div>
                    </div>
                    <div class="terminal-status ${statusClass}">${statusText}</div>
                    <div class="terminal-actions">
                        <button class="btn btn-primary" data-id="${terminal.id}">
                            <i class="fas fa-sync-alt"></i> Sync
                        </button>
                        <button class="btn btn-warning" data-id="${terminal.id}">
                            <i class="fas fa-ban"></i> Bloquer
                        </button>
                        <button class="btn btn-danger" data-id="${terminal.id}">
                            <i class="fas fa-power-off"></i> Fermer
                        </button>
                    </div>
                `;
                
                terminalsList.appendChild(terminalItem);
            });
            
            // Ajouter les écouteurs d'événements pour les boutons
            document.querySelectorAll('.terminal-actions .btn').forEach(btn => {
                btn.addEventListener('click', function() {
                    const terminalId = this.getAttribute('data-id');
                    const action = this.classList.contains('btn-primary') ? 'sync' : 
                                  this.classList.contains('btn-warning') ? 'block' : 'shutdown';
                    
                    handleTerminalAction(terminalId, action);
                });
            });
        }
        
        // Mettre à jour la liste des tickets
        function updateTicketsList() {
            const ticketsList = document.getElementById('tickets-list');
            ticketsList.innerHTML = '';
            
            if (receivedTickets.length === 0) {
                ticketsList.innerHTML = '<p>Aucun ticket reçu pour le moment.</p>';
                return;
            }
            
            receivedTickets.forEach(ticket => {
                const ticketItem = document.createElement('div');
                ticketItem.className = 'data-item';
                
                const date = new Date(ticket.timestamp).toLocaleString();
                let content = '';
                
                if (ticket.bets && Array.isArray(ticket.bets)) {
                    ticket.bets.forEach(bet => {
                        content += `<div>${bet.name}: ${bet.number} - ${bet.amount} G</div>`;
                    });
                } else if (ticket.data) {
                    content = `<div>${JSON.stringify(ticket.data)}</div>`;
                }
                
                ticketItem.innerHTML = `
                    <div class="data-header">
                        <span class="data-terminal">${ticket.terminalId || 'Inconnu'}</span>
                        <span class="data-date">${date}</span>
                    </div>
                    <div class="data-content">
                        ${content}
                    </div>
                    <div class="data-total">
                        Total: ${ticket.total || 0} G
                    </div>
                `;
                
                ticketsList.appendChild(ticketItem);
            });
        }
        
        // Mettre à jour la liste des codes
        function updateCodesList() {
            const codesList = document.getElementById('codes-list');
            codesList.innerHTML = '';
            
            if (accessCodes.length === 0) {
                codesList.innerHTML = '<p>Aucun code d\'accès généré.</p>';
                return;
            }
            
            accessCodes.forEach(code => {
                const codeItem = document.createElement('div');
                codeItem.className = 'code-item';
                
                const statusClass = code.active ? 'status-active' : 'status-inactive';
                const statusText = code.active ? 'Actif' : 'Inactif';
                const typeText = code.type === 'admin' ? 'Administrateur' : 'Agent';
                const lastUsed = code.lastUsed ? new Date(code.lastUsed).toLocaleDateString() : 'Jamais';
                const deviceInfo = code.deviceId ? `Appareil: ${code.deviceId.substring(0, 8)}...` : 'Non utilisé';
                
                codeItem.innerHTML = `
                    <div class="code-details">
                        <div class="code-value">${code.code}</div>
                        <div class="code-type">${typeText} - ${deviceInfo}</div>
                        <div class="code-meta">Créé: ${new Date(code.createdAt).toLocaleDateString()} - Dernier usage: ${lastUsed}</div>
                    </div>
                    <div class="code-status ${statusClass}">${statusText}</div>
                    <div class="code-actions">
                        <button class="btn btn-sm ${code.active ? 'btn-warning' : 'btn-success'}" data-id="${code.id}" data-action="toggle">
                            ${code.active ? 'Désactiver' : 'Activer'}
                        </button>
                        <button class="btn btn-sm btn-danger" data-id="${code.id}" data-action="delete">
                            <i class="fas fa-trash"></i>
                        </button>
                    </div>
                `;
                
                codesList.appendChild(codeItem);
            });
            
            // Ajouter les écouteurs d'événements
            document.querySelectorAll('.code-actions .btn').forEach(btn => {
                btn.addEventListener('click', function() {
                    const codeId = this.getAttribute('data-id');
                    const action = this.getAttribute('data-action');
                    
                    if (action === 'toggle') {
                        toggleAccessCode(codeId);
                    } else if (action === 'delete') {
                        deleteAccessCode(codeId);
                    }
                });
            });
        }
        
        // Mettre à jour le contrôle des jeux
        function updateGamesControl() {
            const gamesGrid = document.getElementById('games-grid');
            gamesGrid.innerHTML = '';
            
            games.forEach(game => {
                const gameItem = document.createElement('div');
                gameItem.className = 'game-item';
                
                gameItem.innerHTML = `
                    <div class="game-name">${game.name}</div>
                    <label class="toggle-switch">
                        <input type="checkbox" ${game.enabled ? 'checked' : ''} data-id="${game.id}">
                        <span class="slider"></span>
                    </label>
                `;
                
                gamesGrid.appendChild(gameItem);
            });
            
            // Ajouter les écouteurs d'événements pour les interrupteurs
            document.querySelectorAll('.toggle-switch input').forEach(switchEl => {
                switchEl.addEventListener('change', function() {
                    const gameId = this.getAttribute('data-id');
                    const enabled = this.checked;
                    
                    updateGameStatus(gameId, enabled);
                });
            });
        }
        
        // Mettre à jour la liste des gagnants
        function updateWinnersList() {
            const winnersList = document.getElementById('winners-list');
            winnersList.innerHTML = '';
            
            if (winners.length === 0) {
                winnersList.innerHTML = '<p>Aucun gagnant enregistré pour le moment.</p>';
                return;
            }
            
            winners.forEach(winner => {
                const winnerItem = document.createElement('div');
                winnerItem.className = 'winner-item';
                
                const drawName = getDrawName(winner.draw);
                const numbers = winner.numbers ? winner.numbers.join(', ') : '';
                const date = winner.date ? new Date(winner.date).toLocaleString() : '';
                
                winnerItem.innerHTML = `
                    <div class="winner-details">
                        <strong>${drawName}</strong><br>
                        <span>${numbers}</span><br>
                        <small>${date}</small>
                    </div>
                    <div class="winner-actions">
                        <button class="btn btn-danger" data-id="${winner.id}">
                            <i class="fas fa-trash"></i>
                        </button>
                    </div>
                `;
                
                winnersList.appendChild(winnerItem);
            });
            
            // Ajouter les écouteurs d'événements pour les boutons de suppression
            document.querySelectorAll('.winner-actions .btn').forEach(btn => {
                btn.addEventListener('click', function() {
                    const winnerId = this.getAttribute('data-id');
                    removeWinner(winnerId);
                });
            });
        }
        
        // Mettre à jour les journaux
        function updateLogs() {
            const logsContainer = document.getElementById('logs-container');
            logsContainer.innerHTML = '';
            
            // Afficher les 50 derniers journaux
            const recentLogs = systemLogs.slice(-50);
            
            recentLogs.forEach(log => {
                const logEntry = document.createElement('div');
                logEntry.className = 'log-entry';
                
                const time = new Date(log.timestamp).toLocaleTimeString();
                const logClass = `log-${log.type}`;
                
                logEntry.innerHTML = `
                    <span class="log-time">[${time}]</span>
                    <span class="${logClass}">${log.message}</span>
                `;
                
                logsContainer.appendChild(logEntry);
            });
            
            // Faire défiler vers le bas
            logsContainer.scrollTop = logsContainer.scrollHeight;
        }
        
        // Ajouter un journal
        function addLog(message, type = 'info') {
            const logEntry = {
                timestamp: new Date(),
                message: message,
                type: type
            };
            
            systemLogs.push(logEntry);
            updateLogs();
        }
        
        // Obtenir le nom du tirage
        function getDrawName(drawId) {
            const drawNames = {
                'miami-morning': 'Miami (Matin)',
                'miami-evening': 'Miami (Soir)',
                'georgia-morning': 'Georgia (Matin)',
                'georgia-evening': 'Georgia (Soir)',
                'newyork-morning': 'New York (Matin)',
                'newyork-evening': 'New York (Soir)',
                'texas-morning': 'Texas (Matin)',
                'texas-evening': 'Texas (Soir)'
            };
            
            return drawNames[drawId] || drawId;
        }
        
        // Changer d'onglet
        function switchTab(tabId) {
            // Désactiver tous les onglets
            document.querySelectorAll('.tab').forEach(tab => {
                tab.classList.remove('active');
            });
            
            document.querySelectorAll('.tab-content').forEach(content => {
                content.classList.remove('active');
            });
            
            // Activer l'onglet sélectionné
            document.querySelector(`.tab[data-tab="${tabId}"]`).classList.add('active');
            document.getElementById(`${tabId}-tab`).classList.add('active');
        }
        
        // Gérer les actions sur les terminaux
        async function handleTerminalAction(terminalId, action) {
            const terminal = terminals.find(t => t.id === terminalId);
            if (!terminal) return;
            
            switch(action) {
                case 'sync':
                    addLog(`Synchronisation demandée pour ${terminal.name || terminal.id}`, 'info');
                    await sendCommandToTerminal(terminalId, 'SYNC');
                    break;
                    
                case 'block':
                    addLog(`Blocage demandé pour ${terminal.name || terminal.id}`, 'warning');
                    await sendCommandToTerminal(terminalId, 'BLOCK');
                    break;
                    
                case 'shutdown':
                    addLog(`Arrêt demandé pour ${terminal.name || terminal.id}`, 'warning');
                    await sendCommandToTerminal(terminalId, 'SHUTDOWN');
                    break;
            }
        }
        
        // Envoyer une commande à un terminal
        async function sendCommandToTerminal(terminalId, command) {
            if (!db) {
                addLog(`Commande ${command} envoyée à ${terminalId} (simulation)`, 'success');
                return;
            }
            
            try {
                await db.collection("terminal_commands").add({
                    terminalId: terminalId,
                    command: command,
                    timestamp: new Date().toISOString(),
                    status: 'pending',
                    sentBy: currentAdminCode
                });
                
                addLog(`Commande ${command} envoyée à ${terminalId}`, 'success');
            } catch (error) {
                addLog(`Erreur envoi commande à ${terminalId}: ${error.message}`, 'error');
            }
        }
        
        // Mettre à jour le statut d'un jeu
        function updateGameStatus(gameId, enabled) {
            const game = games.find(g => g.id === gameId);
            if (game) {
                game.enabled = enabled;
                addLog(`Jeu ${game.name} ${enabled ? 'activé' : 'désactivé'}`, 'info');
            }
        }
        
        // Actualiser les données
        function refreshData() {
            addLog('Actualisation des données demandée', 'info');
            
            // Simulation de l'actualisation des données
            setTimeout(() => {
                updateDashboard();
                addLog('Données actualisées avec succès', 'success');
            }, 1000);
        }
        
        // Envoyer les gagnants aux terminaux
        async function sendWinnersToTerminals() {
            if (winners.length === 0) {
                alert('Aucun gagnant à envoyer.');
                return;
            }
            
            addLog('Envoi des gagnants aux terminaux', 'info');
            
            try {
                // Envoyer à Firebase
                if (db) {
                    await db.collection("announcements").add({
                        type: 'winners',
                        data: winners,
                        timestamp: new Date().toISOString(),
                        sentTo: selectedTerminals
                    });
                }
                
                addLog(`Gagnants envoyés à ${selectedTerminals.length} terminaux`, 'success');
                alert('Gagnants envoyés avec succès à tous les terminaux sélectionnés.');
            } catch (error) {
                addLog(`Erreur envoi gagnants: ${error.message}`, 'error');
            }
        }
        
        // Arrêter tous les terminaux
        async function shutdownAllTerminals() {
            if (!confirm('Êtes-vous sûr de vouloir arrêter tous les terminaux ?')) {
                return;
            }
            
            addLog('Arrêt de tous les terminaux demandé', 'warning');
            
            try {
                // Envoyer la commande à tous les terminaux
                for (const terminal of terminals) {
                    await sendCommandToTerminal(terminal.id, 'SHUTDOWN');
                }
                
                addLog('Tous les terminaux ont reçu la commande d\'arrêt', 'success');
                alert('Commande d\'arrêt envoyée à tous les terminaux.');
            } catch (error) {
                addLog(`Erreur arrêt terminaux: ${error.message}`, 'error');
            }
        }
        
        // Appliquer les jeux aux terminaux
        async function applyGamesToTerminals() {
            if (selectedTerminals.length === 0) {
                alert('Veuillez sélectionner au moins un terminal.');
                return;
            }
            
            const enabledGames = games.filter(g => g.enabled).map(g => g.id);
            addLog(`Application des jeux aux terminaux: ${enabledGames.join(', ')}`, 'info');
            
            try {
                // Envoyer la configuration à Firebase
                if (db) {
                    await db.collection("configurations").add({
                        type: 'games',
                        enabledGames: enabledGames,
                        timestamp: new Date().toISOString(),
                        sentTo: selectedTerminals
                    });
                }
                
                addLog(`Configuration des jeux appliquée à ${selectedTerminals.length} terminaux`, 'success');
                alert('Configuration des jeux appliquée avec succès aux terminaux sélectionnés.');
            } catch (error) {
                addLog(`Erreur application jeux: ${error.message}`, 'error');
            }
        }
        
        // Synchroniser les tickets
        async function syncTickets() {
            addLog('Synchronisation des tickets demandée', 'info');
            
            // Dans une vraie application, vous récupéreriez les tickets depuis l'API
            // Pour l'instant, nous simulons
            setTimeout(() => {
                addLog('Tickets synchronisés avec succès', 'success');
                alert('Tickets synchronisés avec succès.');
            }, 1500);
        }
        
        // Effacer les anciens tickets
        async function clearOldTickets() {
            if (!confirm('Êtes-vous sûr de vouloir effacer les tickets de plus de 7 jours ?')) {
                return;
            }
            
            addLog('Nettoyage des anciens tickets', 'info');
            
            try {
                if (db) {
                    const weekAgo = new Date();
                    weekAgo.setDate(weekAgo.getDate() - 7);
                    
                    const oldTickets = await db.collection("tickets")
                        .where("timestamp", "<", weekAgo.toISOString())
                        .get();
                    
                    const batch = db.batch();
                    oldTickets.docs.forEach(doc => {
                        batch.delete(doc.ref);
                    });
                    
                    await batch.commit();
                    addLog(`${oldTickets.size} anciens tickets effacés`, 'success');
                } else {
                    addLog('Nettoyage des anciens tickets (simulation)', 'success');
                }
                
                alert('Anciens tickets effacés avec succès.');
            } catch (error) {
                addLog(`Erreur nettoyage tickets: ${error.message}`, 'error');
            }
        }
        
        // Générer des codes d'accès
        async function generateAccessCodes() {
            const count = parseInt(document.getElementById('generate-count').value);
            const type = document.getElementById('code-type').value;
            
            if (!count || count < 1 || count > 100) {
                alert('Veuillez entrer un nombre valide entre 1 et 100');
                return;
            }
            
            addLog(`Génération de ${count} codes ${type}`, 'info');
            
            try {
                const newCodes = [];
                
                for (let i = 0; i < count; i++) {
                    const code = generateRandomCode(type);
                    newCodes.push({
                        code: code,
                        type: type,
                        active: true,
                        createdAt: new Date().toISOString(),
                        createdBy: currentAdminCode
                    });
                }
                
                // Sauvegarder dans Firebase
                if (db) {
                    const batch = db.batch();
                    newCodes.forEach(code => {
                        const docRef = db.collection("access_codes").doc();
                        batch.set(docRef, code);
                    });
                    
                    await batch.commit();
                    addLog(`${count} codes ${type} générés avec succès`, 'success');
                } else {
                    // Mode démo - stocker localement
                    newCodes.forEach(code => {
                        accessCodes.push({
                            id: 'demo_' + Date.now() + '_' + Math.random(),
                            ...code
                        });
                    });
                    updateCodesList();
                    addLog(`${count} codes ${type} générés (mode démo)`, 'success');
                }
                
                alert(`${count} codes ${type} générés avec succès !`);
                
            } catch (error) {
                addLog(`Erreur génération codes: ${error.message}`, 'error');
            }
        }
        
        // Générer un code aléatoire
        function generateRandomCode(type) {
            const prefix = type === 'admin' ? 'ADM' : 'AGT';
            const chars = 'ABCDEFGHJKLMNPQRSTUVWXYZ23456789'; // Éviter les caractères ambigus
            let code = prefix;
            
            for (let i = 0; i < 6; i++) {
                code += chars.charAt(Math.floor(Math.random() * chars.length));
            }
            
            return code;
        }
        
        // Rechercher des codes
        function searchCodes() {
            const searchTerm = document.getElementById('search-code').value.toLowerCase();
            const codeItems = document.querySelectorAll('#codes-list .code-item');
            
            codeItems.forEach(item => {
                const text = item.textContent.toLowerCase();
                if (text.includes(searchTerm)) {
                    item.style.display = 'flex';
                } else {
                    item.style.display = 'none';
                }
            });
        }
        
        // Basculer l'état d'un code
        async function toggleAccessCode(codeId) {
            try {
                if (db) {
                    const codeRef = db.collection("access_codes").doc(codeId);
                    const codeDoc = await codeRef.get();
                    
                    if (codeDoc.exists) {
                        const currentStatus = codeDoc.data().active;
                        await codeRef.update({ active: !currentStatus });
                        
                        addLog(`Code ${codeId} ${!currentStatus ? 'activé' : 'désactivé'}`, 'success');
                    }
                } else {
                    // Mode démo
                    const code = accessCodes.find(c => c.id === codeId);
                    if (code) {
                        code.active = !code.active;
                        updateCodesList();
                        addLog(`Code ${codeId} ${code.active ? 'activé' : 'désactivé'} (mode démo)`, 'success');
                    }
                }
            } catch (error) {
                addLog(`Erreur modification code: ${error.message}`, 'error');
            }
        }
        
        // Supprimer un code
        async function deleteAccessCode(codeId) {
            if (!confirm('Êtes-vous sûr de vouloir supprimer ce code ?')) return;
            
            try {
                if (db) {
                    await db.collection("access_codes").doc(codeId).delete();
                    addLog(`Code ${codeId} supprimé`, 'warning');
                } else {
                    // Mode démo
                    accessCodes = accessCodes.filter(c => c.id !== codeId);
                    updateCodesList();
                    addLog(`Code ${codeId} supprimé (mode démo)`, 'warning');
                }
            } catch (error) {
                addLog(`Erreur suppression code: ${error.message}`, 'error');
            }
        }
        
        // Afficher le modal de sélection des terminaux
        function showTerminalsModal() {
            const modal = document.getElementById('terminals-modal');
            const terminalSelector = document.getElementById('terminal-selector');
            
            terminalSelector.innerHTML = '';
            
            terminals.forEach(terminal => {
                const isSelected = selectedTerminals.includes(terminal.id);
                const terminalOption = document.createElement('div');
                terminalOption.className = `terminal-option ${isSelected ? 'selected' : ''}`;
                terminalOption.setAttribute('data-id', terminal.id);
                terminalOption.textContent = `${terminal.name || terminal.id}`;
                
                terminalOption.addEventListener('click', function() {
                    const terminalId = this.getAttribute('data-id');
                    toggleTerminalSelection(terminalId);
                });
                
                terminalSelector.appendChild(terminalOption);
            });
            
            modal.style.display = 'flex';
        }
        
        // Fermer le modal
        function closeModal() {
            document.getElementById('terminals-modal').style.display = 'none';
        }
        
        // Basculer la sélection d'un terminal
        function toggleTerminalSelection(terminalId) {
            const index = selectedTerminals.indexOf(terminalId);
            
            if (index === -1) {
                selectedTerminals.push(terminalId);
            } else {
                selectedTerminals.splice(index, 1);
            }
            
            // Mettre à jour l'affichage
            document.querySelectorAll('.terminal-option').forEach(option => {
                const id = option.getAttribute('data-id');
                if (selectedTerminals.includes(id)) {
                    option.classList.add('selected');
                } else {
                    option.classList.remove('selected');
                }
            });
        }
        
        // Sélectionner tous les terminaux
        function selectAllTerminals() {
            selectedTerminals = terminals.map(t => t.id);
            
            document.querySelectorAll('.terminal-option').forEach(option => {
                option.classList.add('selected');
            });
        }
        
        // Désélectionner tous les terminaux
        function deselectAllTerminals() {
            selectedTerminals = [];
            
            document.querySelectorAll('.terminal-option').forEach(option => {
                option.classList.remove('selected');
            });
        }
        
        // Confirmer la sélection des terminaux
        function confirmTerminalSelection() {
            addLog(`Terminaux sélectionnés: ${selectedTerminals.length}`, 'info');
            closeModal();
        }
        
        // Ajouter des gagnants
        async function addWinners() {
            const drawSelect = document.getElementById('draw-select');
            const winnerNumbers = document.getElementById('winner-numbers');
            
            const draw = drawSelect.value;
            const numbers = winnerNumbers.value.split(',').map(n => n.trim()).filter(n => n);
            
            if (numbers.length === 0) {
                alert('Veuillez entrer au moins un numéro gagnant.');
                return;
            }
            
            try {
                const winnerData = {
                    draw: draw,
                    numbers: numbers,
                    date: new Date().toISOString(),
                    addedBy: currentAdminCode
                };
                
                if (db) {
                    await db.collection("winners").add(winnerData);
                } else {
                    // Mode démo
                    winners.push({
                        id: 'demo_' + Date.now(),
                        ...winnerData
                    });
                    updateWinnersList();
                }
                
                winnerNumbers.value = '';
                
                addLog(`Gagnants ajoutés pour ${getDrawName(draw)}: ${numbers.join(', ')}`, 'success');
                alert('Gagnants ajoutés avec succès.');
            } catch (error) {
                addLog(`Erreur ajout gagnants: ${error.message}`, 'error');
            }
        }
        
        // Publier les gagnants
        async function publishWinners() {
            if (winners.length === 0) {
                alert('Aucun gagnant à publier.');
                return;
            }
            
            addLog('Publication des gagnants', 'info');
            
            try {
                // Envoyer à Firebase
                if (db) {
                    await db.collection("announcements").add({
                        type: 'winners_published',
                        timestamp: new Date().toISOString(),
                        message: 'Les gagnants ont été publiés'
                    });
                }
                
                addLog('Gagnants publiés avec succès', 'success');
                alert('Gagnants publiés avec succès. Tous les terminaux ont été notifiés.');
            } catch (error) {
                addLog(`Erreur publication gagnants: ${error.message}`, 'error');
            }
        }
        
        // Supprimer un gagnant
        async function removeWinner(winnerId) {
            if (!confirm('Êtes-vous sûr de vouloir supprimer ces gagnants ?')) {
                return;
            }
            
            try {
                if (db) {
                    await db.collection("winners").doc(winnerId).delete();
                } else {
                    // Mode démo
                    winners = winners.filter(w => w.id !== winnerId);
                    updateWinnersList();
                }
                
                addLog('Gagnants supprimés', 'warning');
            } catch (error) {
                addLog(`Erreur suppression gagnants: ${error.message}`, 'error');
            }
        }
        
        // Sauvegarder les paramètres
        function saveSettings() {
            try {
                const firebaseConfigText = document.getElementById('firebase-config').value;
                let config;
                
                if (firebaseConfigText) {
                    config = JSON.parse(firebaseConfigText);
                }
                
                serverSettings = {
                    port: parseInt(document.getElementById('server-port').value),
                    syncInterval: parseInt(document.getElementById('sync-interval').value),
                    autoShutdown: document.getElementById('auto-shutdown').value,
                    firebaseConfig: config || firebaseConfig
                };
                
                localStorage.setItem('novaLottoControlSettings', JSON.stringify(serverSettings));
                
                // Reinitialiser Firebase avec la nouvelle configuration
                if (config && config.apiKey !== firebaseConfig.apiKey) {
                    firebaseConfig = config;
                    try {
                        if (firebaseApp) {
                            firebaseApp.delete();
                        }
                        initializeFirebase();
                    } catch (error) {
                        addLog('Erreur reinitialisation Firebase: ' + error.message, 'error');
                    }
                }
                
                addLog('Paramètres sauvegardés avec succès', 'success');
                alert('Paramètres sauvegardés avec succès.');
            } catch (error) {
                addLog('Erreur sauvegarde paramètres: ' + error.message, 'error');
                alert('Erreur: ' + error.message);
            }
        }
        
        // Tester Firebase
        async function testFirebase() {
            if (!db) {
                alert('Firebase n\'est pas initialisé. Veuillez configurer Firebase d\'abord.');
                return;
            }
            
            addLog('Test de connexion Firebase...', 'info');
            
            try {
                // Tester une simple opération
                await db.collection("test").doc("connection").set({
                    test: true,
                    timestamp: new Date().toISOString()
                });
                
                await db.collection("test").doc("connection").delete();
                
                addLog('Connexion Firebase testée avec succès', 'success');
                alert('Connexion Firebase établie avec succès !');
            } catch (error) {
                addLog('Erreur connexion Firebase: ' + error.message, 'error');
                alert('Erreur Firebase: ' + error.message);
            }
        }
        
        // Simuler les mises à jour en temps réel
        function simulateRealTimeUpdates() {
            if (!isAuthenticated) return;
            
            // Simulation de mises à jour aléatoires
            if (Math.random() < 0.1) {
                const terminalUpdates = [
                    { id: 'terminal-001', sales: '+50' },
                    { id: 'terminal-002', sales: '+30' },
                    { id: 'terminal-004', sales: '+20' }
                ];
                
                terminalUpdates.forEach(update => {
                    const terminal = terminals.find(t => t.id === update.id);
                    if (terminal) {
                        terminal.sales = (terminal.sales || 0) + parseInt(update.sales);
                    }
                });
                
                updateDashboard();
                updateTerminalsList();
            }
        }
        
        // Démarrer la simulation
        setInterval(simulateRealTimeUpdates, 10000);
    </script>
</body>
</html>